# Breaking Monero 04: Chain Splits (Key Image Reuse Attack) 
*06/09/19*  
_**In this episode, Sarang, Brandon (Suare), and Justin introduce key image reuse concerns.**_  

**Breaking Monero Episode 04: Chain Splits (Key Image Reuse Attack)**  

https://youtu.be/6CVcirD90pg  
In this episode, Sarang, Brandon (Suare), and Justin introduce key image reuse concerns. We explain some techniques to protect security and privacy under a number of circumstances. Ultimately, users should not claim “airdrop” funds if they have not thought long and hard about the implications. 

[All Breaking Monero Episodes](https://www.monerooutreach.org/breaking-monero/) 

_**Episode Transcription**_ 

_Justin:_ Welcome back to Breaking Monero. Today we are covering a sensitive topic: Chain Splits. Chain Splits are a really complex topic to cover. In fact, it's one of the real main motivators for having these Breaking Monero episodes. But to give a brief key takeaway if you get nothing else, the best thing you can do is to not claim forks and if you do realize that you are sort of playing with fire and you can easily screw up with many many consequences. So again it's something seeming too complicated just go back to that mid point and we can proceed from there. But I would like to talk about initially how this topic is really tricky to talk about because you can not only just easily screw yourself over if you do something wrong but you can also contribute to reduce security and privacy for others through the sort of a chain reaction scenario we described during the last episodes so see that if you're skipping to this one. But first let's hand it over to Sarang who is going to talk about what key images are and other introductions about sort of hard forks and chains splits.

_Sarang:_ Sure, thanks. So it's good to have everybody back so in the previous episodes we talked a little bit about kind of how the structure of Monero's transactions where the sending elements of the transaction are included in a so-called ring has some consequences for things like zero mix-ins and per-chain reactions. And one thing that I want to emphasize about the way that transactions are structured with rings and it's going to be very very relevant here it is something that we call a key image or it might be called a tag in some versions of the literature. And the important thing to remember with that is if I have for example - as Monero does now - a ring containing 11 (eleven), you know, one-time-use keys and I'm spending one of those. Well, I want to make sure that I can't use one of those keys in a future transaction and double spend. Remember a given one-time key might appear in many different rings but it can only be spent one time so every transaction has... you can kind of think of as like a one-way representation of the actual spending one-time key called the key image associated to it. It's important to note that you cannot look at a transaction look at its key image which is completely out there and publicly posted and determine from that which of the ring members was used. However, if the person who made that transaction attempts to spend the same, you know, Apriori unknown one-time key in a later transaction they will share the same key image. The signature construction makes sure that when you're doing this you can't lie about how you constructed the key image mathematically so it is an effective double spend protection. If you look at two transactions and if they have the same key image then you know that the exact same one-time ring input was used as the sender in that. Although you ideally should not be able to determine which it is so this will become relevant while we're talking about this. I know that Justin, you wanted us to talk a little bit about the different kinds of forks since that's a word that appears sometimes. 

_Justin:_ Absolutely.

Sarang: So there are different ways we can use the word fork. It's important to note that just kind of in the natural mining process of the network we occasionally do get small forks. Since different miners might find different blocks around the same time but eventually those small forks end up going away and that's what we end up meaning when we find consensus among, you know, a longest chain for example. So, at the end of the day even though we have many small forks in the network naturally they're very very short-lived, typically. It's also worth noting that we do regular Network Upgrades to the Monero system these are sometimes called hard forks but I prefer the term Network Upgrade. So technically we are forking away from an old chain to a new chain but in general these are non-contentious, everyone follows the new chain and it's not a big deal so nothing to worry about there. There's also the idea of it's called a code fork we're an open source project you can go on github and look at the Monero source code you are free to do what's called a code fork and basically take that code, modify it and start your own asset. As long as that asset starts its own chain and its own ledger from scratch, nothing to worry about. We have plenty of examples of projects like that, projects like Wownero or Aeon or RYO that are completely safe to use because they use different keys and they have a completely different ledger but the thing we really want to talk about is what I might call a project based chain fork. What these are, are they are typically, you know, new projects with new assets with new names and there's a ton of different ones you know you might have your Diet Monero with lime that claims to be better and what's unique about these is that they actually share part of the older Monero ledger the older Monero chain but at a given time it will basically split off from the actual Monero chain. That's going off in some direction and let basically start their own version of the chain so it kind of forms a Y shape. You have the original shared chain and then you split off there so those are the kind of works that we're going to talk about that are contentious and can cause problems.

_Justin:_ And just to clarify, Sarang, with the example where they often share some of the previous existing chain and then form their own two chains in a Y shape these are sometimes referred to as airdrops in many cases, correct?

_Sarang:_ uhum.

_Justin:_ Okay.

_Sarang:_ Yeah, yeah they are. And typically what might happen with these projects is they might ask you to go up to their wallet, they might ask you to input your Monero private keys and they'll promise you that they'll, you know, drop some of the new Diet Monero with lime in your Diet Monero with lime account.

_Justin:_ Okay, thank you! So I actually want to go through now take the time to walk through some of the previous slides that I gave at DefCon again to talk about this sort of chain split analysis with the key image reuse just so you can see exactly how this happens. So I'm going to share that screen right now... Okay, this presentation is coming a lot of handy so you can see as an example here two different rings one on the left, one on the right each ring, each green circle are two different transactions on the left you have chain 1 (one) let's say that's the Monero chain on the right you have chain 2 (two) let's say that is the Monero Diet with lime for instance. And if you wanted to make two transactions on both chains you would ultimately spend one origin source of funds. So this one source of fund would be before the Y split you it would be generated before this Y split and then after the split these funds would be present on both of these chains. You can see that this yellow output here in this sort of pot of gold as I explained in other episodes is the money that you actually are spending and from each of these you have a key image that is derived. All these black pots or other decoys that are selected from the blockchain so from Monero's blockchain so you can see if you start sort of send two transactions on the two different chains incorrectly or without much care in most cases you're highly likely to choose different outputs in each. So what you would basically do is say: okay, well, here are two transactions with the same key image but there's only one output in each set of rings that actually can be spent. Sure, they are like independently on one of these eleven and... one of these seven in this example outputs could be spent but when you look at these two together there's only one overlapping output that could be spent in both of these transactions. So as a result, what you can do is simply say: okay, well, I know that that's the real output spent so both of these rings are compromised and then therefore, this one output would continue on to do a further chain reaction where you would know this output is spent in this specific transaction so it could impact other transactions too. Now if you are able to take a more mitigated, mitigating route like we explained earlier instead of choosing completely different decoys or again these black pots and in both transactions if you reuse the same exact decoys for both transactions then you could again look for a key image match but every single one of these outputs would be overlapping and you're no longer able to narrow down which outputs are specifically spent. So this is a really nice high-level overview about what chain splits are and how you can sort of see how you're able to find, how you're able to use this as an analysis tool. And from now Brandon is going to actually speak with us about what happens if you actually decide to participate in this chain split what the risks are to users and what the mitigation methods are if any. 

_Brandon:_ So it's, it's funny if you're going to develop a new project and you want to use Bitcoin's code for example you're gonna copy it over and if you want people to use your project soon you may want them to be able to claim funds from the Bitcoin blockchain on your new chain but if you do that you're in a _[unintelligible]_ in Monero. In Bitcoin maybe not a big deal but in Monero you're gonna have a problem because of the diagrams that Justin just showed you if you have a single key image and two totally disjoint key rings that overlap over only on one key you're out of luck. In fact, if you take the intersection of two rings and you only have three keys you still have excluded all of those other keys. So the problem is is that then an observer can go onto the Monero blockchain and can scratch off all of those keys that have been revealed from other rings, excuse me, the key that you spent in your intersected transaction. They can cross that out from other rings and that can lead to what's known as chain reactions. But although, generally you don't really have to worry about it too much I'll let Sarang talk about more about that in a moment here. But when you risk... what are you risking exactly if you use multiple chains? If you provide a signature on two different chains from the same key you're giving more information away than if you only provide one signature. It seems like a really obvious observation but one of the big things that's going on right now in the data science world is that if you have two anonymized sets of data and you combine them you can totally de-anonymize them. So if you start spending your private information on, private keys, on a different ledger you're gonna be risking the built-in anonymity that Monero is trying to provide. But actually one of the biggest risks is the wallet software. Just because the development team has come out with a new project doesn't mean that they're necessarily the ones who are going to come out with a wallet for that project and they should for safety reasons. But if some third party developer comes along and comes out with some Diet Monero with lime vanilla wallet then what's going to end up happening is that you put your Monero keys into somebody random, some random developer's wallet and who knows if they're emailing themselves your keys, who knows? Only way that you can really check is to go through line by line through their code which is why open-source is great but it also means that in order to really safely do this you need to know what you're doing and you need to be a kind of a subject-matter expert. So these airdrop coins are pretty dangerous for a variety of reasons. So one way that you can mitigate this which was described by Justin's diagram a few moments ago is to use the same ring on both chains. If you're going to construct a ring signature you should use both... the same ring in both of them. The problem with that is that unfortunately, sometimes you end up with some of the ring members from before the split and some of the ring members from after the split and then the ones that are from after the split can be excluded, right, and you have an effectively smaller ring size. So let's see here I'm going to go through my list here (to) make sure that I've touched everything... yeah, so if you only use pre fork decoys in your ring signatures you're probably pretty good. If you make sure that you don't construct transactions for two or three days before or after the fork you're probably pretty good. And if you do what we call in the Monero world "churning" you're also pretty good. Although churning is the practice of sending transactions to yourself over and over again, the term actually comes from anonymous communication networks but the main thing is unfortunately for all of these mitigation methods we don't really have strong security claims for any of them. I can't tell you to churn seven, eight, nine times and be confident that you're going to get 256 bits of security out of that in terms of your anonymity. So even though these are mitigation methods, the main thing that you can avoid doing to prevent problems with chain splits is to simply not use them. Another way is to just use brand new burner keys and every single time that you need to spend money on your new chain you make sure that you're spending it from keys that either don't exist on your other chain because you churned and sent transactions to yourself or you just generate a whole new account and you just never ever touch those funds again.

_Justin:_ Yeah, thanks Brandon. One really important just point of clarification is that when you, if you decide to claim funds you should absolutely, in addition to just using a burner account for your Monero, you need to move your Monero out of that account first or else your Monero is also addressed. Like, if someone... if you have Monero on one account and they say give us your Monero private key and we'll give you new coins for instance, well, you're giving away your Monero private key your Monero coins are at risk. Just make sure you remember that at the bare minimum send your Monero to a new account before giving up that private key and make sure there's no other history associated with that account. So thanks Brandon for covering a lot of those basic mitigations that people can take but ultimately as you said you really need to be a subject-matter expert to cover at least a very difficult usecase. If you really care about your privacy you really shouldn't be touching this at all. So Sarang, can you cover what users should do if they're a bystander they don't want to get involved in any of this chain splits nonsense? They just want to stick with Monero. What ultimately communiters do? What risks are they exposed to and how can they mitigate their exposure?

_Sarang:_ Yeah, absolutely. So as we said there are a lot of potential pitfalls that can occur if you decide to participate in one of these chain splits. So the safest bet is to just not participate. I do not participate nor do I wish to participate in any. But as was already hinted at folks who do end up spending funds on both chains of course can reveal which ring member is going to be the true spender on both chains and as was hinted at we can use this in a chain reaction analysis based on being able to remove that particular spent one-time key from other rings on both chains in which they appear. So we are going to lean how one chain reaction work and we also know that one of the reasons that we have increasingly larger ring sizes over time is to make the effects of chain reactions less of a big deal. If I have a ring of size 11 and one of those decoys happens to be a part of a chain split and I've reduced my ring size down to 10 and if this happens a lot that is if there's very very large participation in such a chain split then I reduce my effective ring size more and more. And again I haven't participated in anything I'm just using Monero as expected and my transactions all have rings that contain other decoys that could have participated in it. So if we're not participating what should you do? Well, in general because a lot of this has to do with which decoys you're choosing, the safest, you know, the safest possible thing if you're not sure how popular chain splits are going to be and how effective a chain-reaction might be against your own outputs. In general, you know, maybe if usability is not a big deal for you around that time consider not sending any transactions on the original Monero chain for about maybe two days before and after the split. Now the reason for this we'll talk about in our next episode has to do with the way that we select decoys in general but that's probably the absolute safest thing that you can do. So decoys that are kind of exist in between that is decoys that were created in transactions within this kind of two day range before and after you should consider those fairly high risk decoys as in they are at higher risk of being revealed by someone who created them and then used those in a chain split. So if you're very worried maybe avoid usage. Again this is not great for usability but it's a consequence of the way that Monero transactions and double spend protection work. However, if you must use Monero in those times and of course if we want Monero to be usable we have to assume that some people might need to use it in that time. Well that's the case you generally are going to want to prioritize among the decoys you choosing your transaction decoys that occurred after the chain split after all if a decoy was created after the chain split it does not exist on the other side of that Y and therefore it cannot be spent on the other side of that Y so post split decoys are a better option. Now, of course, again as we're going to talk about in the next episode how outputs are actually selected is actually a very very subtle topic so this isn't necessarily a fully ideal solution but it's a reasonable one if you must use Monero within kind of this two-day before-and-after region. And we also talked before about a previously so-called blackball or a spent output analysis tool that although it takes a while to run can be used to analyze different Y forks and figure out which outputs are absolutely spent and should not be used in a ring. Again this is really only necessary if you're very very worried about the popularity of a chain split as we're going to talk about we typically have not had much popularity with such slits so it's not really been an issue. And finally just kind of a nice social advice is you know follow the community when these occur, you know, typically the community is very much on top of how popular we think such a chain split might be we have a history of dealing with these pretty well so if you want to know when such a split might occur and when this two-day range might happen you know follow the community as much as possible. And of course we have talked again about the idea of churn which is sending funds to yourself this is something you could also do if you have to use it during this time period but again churn is not something that is fully you know understood to our satisfaction. So the absolute safest bet is to avoid that time range and if you must use that time range consider prioritizing outputs that were created after the split as your decoys.

_Justin:_ Excellent! Thank you so much Sarang. So I actually used that spent output tool at the time when I ran it it was still called the blackball tool on several of these Y splits with Monero. So I ran it with Monero version 6 which was the Monero original zero classic fork and also the MoneroV fork in order to sort of determine what the actual results were. What's the real measurable impact that these forks had an individual's and by speaking about these we can help explain how Monero's ring signatures have provided protection and what we sort of need to do going forward. So I ran the tool on August 2018 and I found that 31,000 by 359 rings this is about half a percent of the Rings had reused a key image in an obvious way so it was really obvious what output was actually spent in these rings. So you knew okay this is the clear output it has to be spent in this exact transaction and as a results this had a chain-reaction impact that impacted eight other rings on the blockchain which is less than a thousandth of a percent of Monero transactions.

_Brandon:_ I have a quick question.

_Justin:_ Yeah, go ahead.

_Brandon:_ So, is getting eight rings compromised when starting from 32,000 roughly is that acceptable? See you guys, in your opinion, in terms of anonymity?

_Sarang:_ Well, those numbers are very very different so keep in mind that this 31 or 32 thousand rings on that was basically outputs that people who participated in the fork itself had effect for themselves. So to some extent you know again we advise not participating if you participate it is extremely likely that you would compromise your own output, you'd be one of the thirty two thousand. The eight rings are eight entirely different rings from people who presumably did not participate in that work. So it's not eight of 32,000 it's that thirty two thousand outputs basically chose to screw themselves over and the effect of that was eight other outputs that were affected. That is an extremely low number I think that any number that is not zero is, you know, ideally not acceptable. However, again this is a consequence of the fact that chain splits, you know, have effects on others. It's also important to note - I'm sure Justin was going to mention this anyway but let me steal the thunder for a moment - to note that this was around the time when we were actually increasing our ring size. And remember that increasing a ring size haven't talked about before mitigates against these effects of chain reaction so, you know, worried to have another similar scale chain split now that our ring size is 11? You could expect that number it would I would say probably going to be zero which is great.

_Justin:_ Yeah, absolutely. So speaking to the first, the first what I observed that was when Monero was upgrading from ring size five to seven so the previous chain that sort of continued on that other split stayed at ring size five. Now we're up to ring size eleven so luckily ring signatures have a built-in buffer they have a built-in protection against these varied attacks. So ultimately eight it luckily it is a really small fraction of the total transactions but ultimately I also want it to be zero going forward. I don't want another chain reaction effective happen as results of these chain splits so but I'm generally confident that unless there is a really significant split that has a community torn in Monero that were unlikely this such large chain reactions going forward luckily. So I hopefully this is a worse is sort of behind us so to speak. And I guess one last thought one last posing thought I had is that chain split attacks are partially social attacks. You can't just sit on your home computer and keep splitting Monero over and over, keep making more of these forks and observe information. You have to get a lot of people that are interested in Monero to really become a part of this so as a result we can simply say that sorry... I lost my sentence and train of thought there. Oh yeah so these are partially social attacks you have to get a lot of community involved and luckily since these are social attacks in parts they're relatively easy to observe because people need to know about this to actually claim the funds and make an impact. So it's sort of a multi-level multi-tiered attack surface here. Any final comments from the two of you before we sort of wrap up this episode?

_Brandon:_ Well, I do have one observation. This is not the only problem with the airdrop coins, right? There's a variety of other security issues with them. This is the problem with airdrop coins that applies specifically to ring signature based cryptonote like currencies. So you may be able to go find other articles describing other problems with airdrop coins that are beyond the scope of this discussion.

_Sarang:_ And I guess the only thing that I would really close on is, you know, like so many other things that affect, you know, personal financial digital security it's very very subtle. And in general, you know, I kind of, you know, kind of take on the mantra that if I am not extremely confident in how to do such a thing correctly the best thing to do is just to not do it. So, you know, we've already talked about very subtle it is to participate in these chain splits if you're not extremely confident that you know exactly how to do it correctly to protect yourself you really shouldn't do it. And as we know there are very simple mitigation you can do if you are not participating that can mitigate against the effects of others.

_Justin:_ All right, thank you so much Sarang and Brandon. We're happy to have both of you on again in this episode. Again, the next episode is specifically on the Monero input selection algorithm and how this has consequences of everything to do with ring signatures. It's a really big topic that we have in the next episode so hopefully this chain split episode is really helpful for you. It is one of the really unique parts about Monero and consequences about how Monero prevents double spending. And there's ways to mitigate it but it's important to sort of communicate exactly what the consequences and impacts are to the rest of the community. So hopefully this has been really helpful to everyone here and we're going to... sorry. Yeah and so with that I'm just going to wrap up the episode. Thank you everyone for joining us and see you in the next one.

_Sarang:_ Thank you so much!

_Brandon:_ Bye!

